(function(){var e,t,n,r,i=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};jQuery.fn.extend({imagepicker:function(t){return t==null&&(t={}),this.each(function(){var n;n=jQuery(this),n.next("ul.image_picker_selector").remove(),n.data("picker",new e(this,r(t)));if(t.initialized!=null)return t.initialized()})}}),r=function(e){var t;return t={hide_select:!0,show_label:!1,initialized:void 0,changed:void 0,clicked:void 0,selected:void 0,limit:void 0,limit_reached:void 0},jQuery.extend(t,e)},n=function(e,t){return jQuery(e).not(t).length===0&&jQuery(t).not(e).length===0},e=function(){function e(e,t){this.opts=t!=null?t:{},this.select=jQuery(e),this.multiple=this.select.attr("multiple")==="multiple",this.select.data("limit")!=null&&(this.opts.limit=parseInt(this.select.data("limit"))),this.build_and_append_picker()}return e.prototype.build_and_append_picker=function(){var e;return this.select.is("select")?(this.mode="select",this.target=this.select):(this.mode="checkbox",this.multiple="multiple",this.checkboxes=jQuery("input[name='"+this.select.attr("name")+"']"),this.target=this.checkboxes),this.opts.hide_select&&this.target.hide(),this.opts.hide_select&&this.target.closest("label").hide(),e=this,this.target.each(function(){return jQuery(this).change({picker:e},function(e){return e.data.picker.sync_picker_with_select()})}),this.picker!=null&&this.picker.remove(),this.create_picker(),this.select.parent().is("label")?this.select.parent().after(this.picker):this.select.after(this.picker),this.sync_picker_with_select()},e.prototype.sync_picker_with_select=function(){var e,t,n,r,i;r=this.picker_options,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.is_selected()?i.push(e.mark_as_selected()):i.push(e.unmark_as_selected());return i},e.prototype.get_item_value=function(e){var t;return this.mode==="checkbox"?(t=new Array,jQuery.each(this.checkboxes.filter(":checked"),function(){return t.push(jQuery(this).val())}),t):jQuery(e).val()},e.prototype.set_item_value=function(e,t){var n;return this.mode==="checkbox"?(n=this.select,this.checkboxes.each(function(){return jQuery.inArray(jQuery(this).val(),t)!==-1?jQuery(this).prop("checked",!0):jQuery(this).prop("checked",!1)})):jQuery(e).val(t)},e.prototype.create_picker=function(){return this.picker=jQuery("<ul class='thumbnails image_picker_selector'></ul>"),this.picker_options=[],this.recursively_parse_option_groups(this.select,this.picker),this.picker},e.prototype.recursively_parse_option_groups=function(e,n){var r,i,s,o,u,a,f,l,c,h,p;c=e.children("optgroup");for(u=0,f=c.length;u<f;u++)o=c[u],o=jQuery(o),r=jQuery("<ul></ul>"),r.append(jQuery("<li class='group_title'>"+o.attr("label")+"</li>")),n.append(jQuery("<li>").append(r)),this.recursively_parse_option_groups(o,r);i=[],this.mode==="select"?i=e.children("option"):i=this.checkboxes,h=function(){var e,n,r;r=[];for(e=0,n=i.length;e<n;e++)s=i[e],r.push(new t(s,this,this.opts));return r}.call(this),p=[];for(a=0,l=h.length;a<l;a++){s=h[a],this.picker_options.push(s);if(!s.has_image())continue;p.push(n.append(s.node))}return p},e.prototype.has_implicit_blanks=function(){var e;return function(){var t,n,r,i;r=this.picker_options,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.is_blank()&&!e.has_image()&&i.push(e);return i}.call(this).length>0},e.prototype.selected_values=function(){return this.multiple?this.get_item_value(this.select)||[]:[this.get_item_value(this.select)]},e.prototype.toggle=function(e){var t,r,s;r=this.selected_values(),this.multiple?(s=e.value(),i.call(this.selected_values(),s)>=0)?(t=this.selected_values(),t.splice(r.indexOf(e.value()),1),this.set_item_value(this.select,[]),this.set_item_value(this.select,t)):this.opts.limit!=null&&this.selected_values().length>=this.opts.limit?this.opts.limit_reached!=null&&this.opts.limit_reached.call(this.select):this.set_item_value(this.select,this.selected_values().concat(e.value())):this.has_implicit_blanks()&&e.is_selected()?this.set_item_value(this.select,""):this.set_item_value(this.select,e.value());if(!n(r,this.selected_values())){this.select.change();if(this.opts.changed!=null)return this.opts.changed.call(this.select)}},e}(),t=function(){function e(e,t,n){this.picker=t,this.opts=n!=null?n:{},this.option=jQuery(e),this.create_node()}return e.prototype.has_image=function(){return this.option.data("img-src")!=null},e.prototype.is_blank=function(){return this.value()==null||this.value()===""},e.prototype.is_selected=function(){var e;return e=this.picker.get_item_value(this.picker.select),this.picker.multiple?jQuery.inArray(this.value(),e)>=0:this.value()===e},e.prototype.mark_as_selected=function(){return this.node.find(".thumbnail").addClass("selected")},e.prototype.unmark_as_selected=function(){return this.node.find(".thumbnail").removeClass("selected")},e.prototype.value=function(){return this.picker.get_item_value(this.option),this.option.val()},e.prototype.label=function(){return this.option.data("img-label")?this.option.data("img-label"):this.option.text()},e.prototype.clicked=function(){this.picker.toggle(this),this.opts.clicked!=null&&this.opts.clicked.call(this.picker.select);if(this.opts.selected!=null&&this.is_selected())return this.opts.selected.call(this.picker.select)},e.prototype.create_node=function(){var e,t;return this.node=jQuery("<li/>"),e=jQuery("<img class='image_picker_image'/>"),e.attr("src",this.option.data("img-src")),t=jQuery("<div class='thumbnail'>"),t.click({option:this},function(e){return e.data.option.clicked()}),t.append(e),this.opts.show_label&&t.append(jQuery("<p/>").html(this.label())),this.node.append(t),this.node},e}()}).call(this);